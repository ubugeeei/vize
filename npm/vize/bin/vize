#!/usr/bin/env node

import { spawn } from "child_process";
import { createRequire } from "module";
import { dirname, join } from "path";

const require = createRequire(import.meta.url);

const PLATFORMS = {
  "darwin-x64": { pkg: "@vizejs/cli-darwin-x64", bin: "vize" },
  "darwin-arm64": { pkg: "@vizejs/cli-darwin-arm64", bin: "vize" },
  "linux-x64": { pkg: "@vizejs/cli-linux-x64", bin: "vize" },
  "linux-arm64": { pkg: "@vizejs/cli-linux-arm64", bin: "vize" },
  "win32-x64": { pkg: "@vizejs/cli-win32-x64", bin: "vize.exe" },
  "win32-arm64": { pkg: "@vizejs/cli-win32-arm64", bin: "vize.exe" },
};

const platform = `${process.platform}-${process.arch}`;
const config = PLATFORMS[platform];

if (!config) {
  console.error(`Unsupported platform: ${platform}`);
  console.error("You can install from source: cargo install vize");
  process.exit(1);
}

let binaryPath;
try {
  const pkgDir = dirname(require.resolve(`${config.pkg}/package.json`));
  binaryPath = join(pkgDir, config.bin);
} catch {
  console.error(`Vize binary package not found: ${config.pkg}`);
  console.error("Try reinstalling: npm install vize");
  process.exit(1);
}

const child = spawn(binaryPath, process.argv.slice(2), {
  stdio: "inherit",
  env: process.env,
});

child.on("error", (err) => {
  console.error(`Failed to start Vize: ${err.message}`);
  process.exit(1);
});

child.on("close", (code) => {
  process.exit(code ?? 0);
});
