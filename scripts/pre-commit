#!/bin/bash

set -e

echo "üîç Running pre-commit checks in parallel..."

# Create temp files for results and output
FMT_RESULT=$(mktemp)
FMT_OUTPUT=$(mktemp)
CLIPPY_RESULT=$(mktemp)
CLIPPY_OUTPUT=$(mktemp)
TEST_RESULT=$(mktemp)
TEST_OUTPUT=$(mktemp)

# Run all checks in parallel, capturing output
(
    if cargo fmt --all -- --check > "$FMT_OUTPUT" 2>&1; then
        echo "0" > "$FMT_RESULT"
    else
        echo "1" > "$FMT_RESULT"
    fi
) &
FMT_PID=$!

(
    if cargo clippy --workspace -- -D warnings > "$CLIPPY_OUTPUT" 2>&1; then
        echo "0" > "$CLIPPY_RESULT"
    else
        echo "1" > "$CLIPPY_RESULT"
    fi
) &
CLIPPY_PID=$!

(
    if cargo test --workspace > "$TEST_OUTPUT" 2>&1; then
        echo "0" > "$TEST_RESULT"
    else
        echo "1" > "$TEST_RESULT"
    fi
) &
TEST_PID=$!

# Wait for all and collect results
wait $FMT_PID
wait $CLIPPY_PID
wait $TEST_PID

FMT_EXIT=$(cat "$FMT_RESULT")
CLIPPY_EXIT=$(cat "$CLIPPY_RESULT")
TEST_EXIT=$(cat "$TEST_RESULT")

# Report results
FAILED=0

if [ "$FMT_EXIT" = "0" ]; then
    echo "‚úÖ Format OK"
else
    echo "‚ùå Format check failed:"
    echo "----------------------------------------"
    cat "$FMT_OUTPUT"
    echo "----------------------------------------"
    FAILED=1
fi

if [ "$CLIPPY_EXIT" = "0" ]; then
    echo "‚úÖ Clippy OK"
else
    echo "‚ùå Clippy check failed:"
    echo "----------------------------------------"
    cat "$CLIPPY_OUTPUT"
    echo "----------------------------------------"
    FAILED=1
fi

if [ "$TEST_EXIT" = "0" ]; then
    echo "‚úÖ Tests OK"
else
    echo "‚ùå Tests failed:"
    echo "----------------------------------------"
    cat "$TEST_OUTPUT"
    echo "----------------------------------------"
    FAILED=1
fi

# Cleanup temp files
rm -f "$FMT_RESULT" "$FMT_OUTPUT" "$CLIPPY_RESULT" "$CLIPPY_OUTPUT" "$TEST_RESULT" "$TEST_OUTPUT"

if [ "$FAILED" = "1" ]; then
    echo "üí• Pre-commit checks failed!"
    exit 1
fi

echo "üéâ All pre-commit checks passed!"
