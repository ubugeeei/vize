#!/bin/bash

set -e

# Colors
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
BOLD='\033[1m'
RESET='\033[0m'

echo -e "${BOLD}Running pre-commit checks in parallel...${RESET}"

# Create temp files for results
FMT_RESULT=$(mktemp)
CLIPPY_RESULT=$(mktemp)
TEST_RESULT=$(mktemp)

# Run all checks in parallel with prefixed output
(
    echo -e "${BLUE}[fmt]${RESET} Starting format check..."
    if cargo fmt --all -- --check 2>&1 | sed "s/^/$(printf "${BLUE}[fmt]${RESET} ")/"; then
        echo "0" > "$FMT_RESULT"
        echo -e "${BLUE}[fmt]${RESET} Done"
    else
        echo "1" > "$FMT_RESULT"
        echo -e "${BLUE}[fmt]${RESET} ${RED}Failed${RESET}"
    fi
) &
FMT_PID=$!

(
    echo -e "${MAGENTA}[clippy]${RESET} Starting clippy check..."
    if cargo clippy --workspace -- -D warnings 2>&1 | sed "s/^/$(printf "${MAGENTA}[clippy]${RESET} ")/"; then
        echo "0" > "$CLIPPY_RESULT"
        echo -e "${MAGENTA}[clippy]${RESET} Done"
    else
        echo "1" > "$CLIPPY_RESULT"
        echo -e "${MAGENTA}[clippy]${RESET} ${RED}Failed${RESET}"
    fi
) &
CLIPPY_PID=$!

(
    echo -e "${CYAN}[test]${RESET} Starting tests..."
    if cargo test --workspace 2>&1 | sed "s/^/$(printf "${CYAN}[test]${RESET} ")/"; then
        echo "0" > "$TEST_RESULT"
        echo -e "${CYAN}[test]${RESET} Done"
    else
        echo "1" > "$TEST_RESULT"
        echo -e "${CYAN}[test]${RESET} ${RED}Failed${RESET}"
    fi
) &
TEST_PID=$!

# Wait for all and collect results
wait $FMT_PID
wait $CLIPPY_PID
wait $TEST_PID

FMT_EXIT=$(cat "$FMT_RESULT")
CLIPPY_EXIT=$(cat "$CLIPPY_RESULT")
TEST_EXIT=$(cat "$TEST_RESULT")

# Cleanup temp files
rm -f "$FMT_RESULT" "$CLIPPY_RESULT" "$TEST_RESULT"

# Report summary
echo ""
echo -e "${BOLD}========================================${RESET}"
echo -e "${BOLD}Summary:${RESET}"
FAILED=0

if [ "$FMT_EXIT" = "0" ]; then
    echo -e "  ${GREEN}[PASS]${RESET} Format"
else
    echo -e "  ${RED}[FAIL]${RESET} Format"
    FAILED=1
fi

if [ "$CLIPPY_EXIT" = "0" ]; then
    echo -e "  ${GREEN}[PASS]${RESET} Clippy"
else
    echo -e "  ${RED}[FAIL]${RESET} Clippy"
    FAILED=1
fi

if [ "$TEST_EXIT" = "0" ]; then
    echo -e "  ${GREEN}[PASS]${RESET} Tests"
else
    echo -e "  ${RED}[FAIL]${RESET} Tests"
    FAILED=1
fi
echo -e "${BOLD}========================================${RESET}"

if [ "$FAILED" = "1" ]; then
    echo -e "${RED}${BOLD}Pre-commit checks failed!${RESET}"
    exit 1
fi

echo -e "${GREEN}${BOLD}All pre-commit checks passed!${RESET}"
